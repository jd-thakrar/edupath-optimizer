# EduPath Optimizer - Firestore Schema Documentation

## Collections Structure

### 1. Users Collection
**Path:** `/users/{userId}`

Stores user authentication and role information.

```json
{
  "uid": "string (Firebase Auth UID)",
  "email": "string",
  "role": "string (student|admin)",
  "name": "string",
  "created_at": "timestamp"
}
```

**Access Rules:**
- Students: Read own document
- Admins: Read all, Write all

---

### 2. Students Collection
**Path:** `/students/{studentId}`

Stores comprehensive academic data for each student. Students have READ-ONLY access.

```json
{
  "student_id": "string (unique identifier)",
  "name": "string",
  "email": "string",
  "enrollment_id": "string",
  "semester": "number (1-8)",
  "department": "string",
  
  "attendance_history": [
    "number (weekly attendance percentages, length ~12)"
  ],
  
  "marks_history": [
    {
      "subject": "string",
      "marks": ["number (test scores out of 20)"]
    }
  ],
  
  "current_subjects": ["string (subject names)"],
  
  "previous_failures": "number",
  
  "last_updated": "timestamp"
}
```

**Example:**
```json
{
  "student_id": "STU0001",
  "name": "Alex Johnson",
  "email": "alex@student.edu",
  "enrollment_id": "EN2021001",
  "semester": 5,
  "department": "Computer Science",
  
  "attendance_history": [78, 76, 74, 72, 70, 68, 67, 65, 63, 61, 60, 58],
  
  "marks_history": [
    {
      "subject": "Data Structures",
      "marks": [15, 14, 13, 12]
    },
    {
      "subject": "Algorithms",
      "marks": [16, 15, 14, 13]
    },
    {
      "subject": "Database Systems",
      "marks": [17, 16, 15]
    }
  ],
  
  "current_subjects": [
    "Data Structures",
    "Algorithms",
    "Database Systems",
    "Operating Systems",
    "Computer Networks"
  ],
  
  "previous_failures": 1,
  
  "last_updated": "2026-01-07T10:30:00Z"
}
```

**Access Rules:**
- Students: Read own document only
- Admins: Full CRUD access

---

### 3. Predictions Collection
**Path:** `/predictions/{predictionId}`

Stores AI-generated risk predictions (generated by backend).

```json
{
  "prediction_id": "string (auto-generated)",
  "student_id": "string (reference to students collection)",
  "timestamp": "timestamp",
  
  "failure_probability": "number (0.0 to 1.0)",
  "confidence": "number (0.0 to 1.0)",
  "risk_level": "string (low|medium|high)",
  "prediction": "number (0=pass, 1=fail)",
  
  "top_features": [
    {
      "feature": "string",
      "importance": "number"
    }
  ],
  
  "future_course_risks": [
    {
      "course": "string",
      "risk": "number (0.0 to 1.0)"
    }
  ],
  
  "ai_explanation": "string (Gemini-generated explanation)"
}
```

**Access Rules:**
- Read: All authenticated users
- Write: Backend service only

---

### 4. Interventions Collection
**Path:** `/interventions/{interventionId}`

Stores counterfactual recommendations (generated by backend).

```json
{
  "intervention_id": "string (auto-generated)",
  "student_id": "string",
  "timestamp": "timestamp",
  
  "current_risk": "number",
  
  "recommendations": [
    {
      "action": "string",
      "description": "string",
      "predicted_risk": "number",
      "risk_reduction": "number",
      "effort_level": "number (1-5)",
      "effectiveness_score": "number",
      "ai_explanation": "string"
    }
  ],
  
  "minimal_safe_path": {
    "status": "string",
    "final_risk": "number",
    "total_effort": "number"
  }
}
```

**Access Rules:**
- Read: All authenticated users
- Write: Backend service only

---

## CSV Upload Format

When admins upload student data via CSV, use this format:

```csv
student_id,name,email,enrollment_id,semester,department,attendance_week_1,attendance_week_2,...,attendance_week_12,subject_1,marks_1_test_1,marks_1_test_2,marks_1_test_3,subject_2,marks_2_test_1,...,current_subjects,previous_failures
STU0001,Alex Johnson,alex@student.edu,EN2021001,5,Computer Science,78,76,74,72,70,68,67,65,63,61,60,58,Data Structures,15,14,13,12,Algorithms,16,15,14,13,"Data Structures,Algorithms,Database Systems,Operating Systems,Computer Networks",1
```

**Note:** The backend will parse this CSV and transform it into the Firestore schema format.

---

## Indexes Required

### Composite Index 1: Student Risk Queries
- Collection: `students`
- Fields: `semester` (ASC), `risk_level` (ASC)
- Query Scope: Collection

### Composite Index 2: Prediction History
- Collection: `predictions`
- Fields: `student_id` (ASC), `timestamp` (DESC)
- Query Scope: Collection

---

## Security Notes

1. **Students NEVER write their own academic data**
   - All academic data (attendance, marks) is uploaded by admins
   - Students have read-only access to their own records

2. **Predictions and Interventions are computed by backend**
   - Only the Flask backend service can write to these collections
   - Frontend only reads and displays

3. **Role-based authentication**
   - User roles stored in `/users/{userId}` collection
   - Firestore rules enforce role-based access
   - Backend verifies Firebase tokens on every API call

4. **Data validation**
   - Backend validates all uploaded data
   - Ensures data completeness before ML processing
   - Rejects malformed or incomplete records
